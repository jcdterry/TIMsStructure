---
title: "Supplementary Information:Brief Guide to Code "
author: "Chris Terry"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction 

This document outlines the code used in the analyses carried out for the paper. It is very far from  a full documentation, as this is not a full package release, but it is hoped that it could be of use. Do email me (Chris Terry) if anything is unclear and you wish to make use of the code.


## Packages and Sourcing
```{r message=FALSE, warning=FALSE}
rm(list=ls())

setwd("~/GitHub/TIMsStructureAndStability")

require(igraph)
require(MASS)
require(tidyverse)
require(pracma)
require(moments)
require(rmutil)
require(cowplot)
require(knitr)
require(kableExtra) # nb need recent version for annotated tables, which may require instrallation from github
require(broom)
require(RColorBrewer)
require(mvtnorm)
require(mgcv)
sapply(paste0('Scripts/',list.files('Scripts/')), source)->tmp
```

# Conducting Stability Analyses of Artificial Webs

The top-level function is `RunArtificialWebAnalysis()`. 

Arguments are details of the trophic network are specified (to be passed to `BuildWeb`), along with the details (model, density and strength) of the TIMs to be added (passed to `AddTIMsToMatrix`). Different TIM distribution models are each generated by a separate function, named `AddxxxxxTIM()`. The short names used here are slightly different to those used in the paper.

`RunArtificialWebAnalysis` returns a single large data.frame where each row is an differently randomly generated model iteration and large number of columns detailing the model used, various structural features and the stability (calculated with `StabilityCriterion`, `RowColStructure`,`TIM_Dist_Examine` and `CalcDegHetero` functions ). 

As a side effect these are saved as an R-object in the working directory, as per `Name`. For convenience I have also include a csv file of the generated data used in the Main Text.

The function used code used to generate the data for the artificial webs using three different specifications of predator-prey interactions:

```{r}
TIMModels<-c('TightRecip','Switching','BoundSw','Scaled',
             'Random', 'Normal','EcoEng', 'Unif',
             'Nearby', 'Far','Positive', 'Negative',   'LaPlace', 
             'IncSkew','DecSkew','RanSkew')
```

```{r eval=FALSE}
FREQ_TO_TEST <- c(1,5, 10,15,  20, 30, 40, 50,0)

set.seed(1)
TMPB0.05<-RunArtificialWebAnalysis(Name = 'Generated Data/Balanced005',mux = -1, sigx= 0.5,
                                   muy =1,  sigy= 0.5, TIMStrength = 0.05,rhoxy = -0.8,
                                   Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST )

set.seed(1)
TMPU0.05<-RunArtificialWebAnalysis(Name = 'Generated Data/Unbalanced005',mux = -5, sigx= 2, 
                                   muy =1,  sigy= 0.5, TIMStrength = 0.05,rhoxy = -0.8,
                                   Repeats=100,Models = TIMModels , FREQ_TO_TEST = FREQ_TO_TEST )

set.seed(1)
TMPV0.05<-RunArtificialWebAnalysis(Name = 'Generated Data/VeryUnbalanced005',mux = -10, sigx= 5,
                                   muy =1,  sigy= 0.5, TIMStrength = 0.05,rhoxy = -0.8,
                                   Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST  )

set.seed(1)
TMPB0.5<-RunArtificialWebAnalysis(Name = 'Generated Data/Balanced05',mux = -1, sigx= 0.5,
                                  muy =1,  sigy= 0.5, TIMStrength = 0.5,rhoxy = -0.8,
                                  Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST  )

set.seed(1)
TMPU0.5<-RunArtificialWebAnalysis(Name = 'Generated Data/Unbalanced05',mux = -5, sigx= 2, 
                                  muy =1,  sigy= 0.5, TIMStrength = 0.5,rhoxy = -0.8,
                                  Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST  )

set.seed(1)
TMPV0.5<-RunArtificialWebAnalysis(Name = 'Generated Data/VeryUnbalanced05',mux = -10, sigx= 5,
                                  muy =1,  sigy= 0.5, TIMStrength = 0.5,rhoxy = -0.8,
                                  Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST  )

set.seed(1)
TMPB5<-RunArtificialWebAnalysis(Name = 'Generated Data/Balanced5',mux = -1, sigx= 0.5,
                                muy =1,  sigy= 0.5, TIMStrength = 5,rhoxy = -0.8,
                                Repeats=100,Models = TIMModels , FREQ_TO_TEST = FREQ_TO_TEST )

set.seed(1)
TMPU5<-RunArtificialWebAnalysis(Name = 'Generated Data/Unbalanced5',mux = -5, sigx= 2, 
                                muy =1,  sigy= 0.5, TIMStrength = 5,rhoxy = -0.8,
                                Repeats=100,Models = TIMModels, FREQ_TO_TEST = FREQ_TO_TEST  )

set.seed(1)
TMPV5<-RunArtificialWebAnalysis(Name = 'Generated Data/VeryUnbalanced5',mux = -10, sigx= 5,
                                muy =1,  sigy= 0.5, TIMStrength = 5,rhoxy = -0.8,
                                Repeats=100,Models = TIMModels , FREQ_TO_TEST = FREQ_TO_TEST )
```

### Loading data
```{r}
load('Generated Data/Balanced005DataFrame')
data-> dataB005
load('Generated Data/Balanced05DataFrame')
data-> dataB05
load('Generated Data/Balanced5DataFrame')
data-> dataB5


load('Generated Data/Unbalanced005DataFrame')
data-> dataU005
load('Generated Data/Unbalanced05DataFrame')
data-> dataU05
load('Generated Data/Unbalanced5DataFrame')
data-> dataU5

load('Generated Data/VeryUnbalanced005DataFrame')
data-> dataV005
load('Generated Data/VeryUnbalanced05DataFrame')
data-> dataV05
load('Generated Data/VeryUnbalanced5DataFrame')
data-> dataV5


dataBal <- bind_rows(dataB005, dataB05, dataB5)
dataUn <- bind_rows(dataU005, dataU05, dataU5)
dataVeUn <- bind_rows(dataV005, dataV05, dataV5)


LevelsOrder <-  c('Normal',
                  'Positive', 'Negative',
                  'Scaled' ,
                  'IncSkew' ,'DecSkew',
                  'Switching','BoundSw',
                  'Random' ,'Nearby',  'Far' ,'EcoEng',
                  'LaPlace', 'Unif' ,
                  'RanSkew' ,   'TightRecip')

dataBal$TIM_Model <- factor(dataBal$TIM_Model, levels = LevelsOrder)
dataUn$TIM_Model <- factor(dataUn$TIM_Model, levels = LevelsOrder)
dataVeUn$TIM_Model <- factor(dataVeUn$TIM_Model, levels = LevelsOrder)

```

# Main Text Figures

### Setting-up names and colours
```{r}
HLs<-brewer.pal(8, 'Set1')

ModelCols <-  c('Switching'=HLs[1],
                'BoundSw' = HLs[2],
                'IncSkew' = HLs[3] ,
                'DecSkew' =  HLs[4],
                'Normal' =  HLs[5] ,
                'Positive' = HLs[8],
                'Negative' = HLs[7],
                'Random' ='black',
                
                'LaPlace' =  "grey",
                'RanSkew' =  "grey",
                'TightRecip'= "grey",
                'EcoEng' = "grey",   
                'Scaled' =  'grey',
                'Nearby'=   "grey",
                'Far' =  "grey",
                'Unif' =  "grey")

LABELS<- c('Switching'= 'Mutual Interference',
           'BoundSw' =  'Bounded Mutual\nInterference',
           'IncSkew' = 'Larger Positive Effects',
           'DecSkew' =   'Larger Negative Effects',
           'Normal' =   'Baseline TIM Model',
           'Positive' =  'Facilitating Modifications',
           'Negative' =  'Interfering Modifications',
           'Random' = 'Random NTEs',
           'LaPlace' =   'Skewed\nStrength Distribution',
           'RanSkew' =   'Unbalanced Effects',
           'TightRecip'= 'Reciprocal Modifications', 
           'EcoEng' =  'Heterogenous\nOut-Degree',
           'Scaled' =  'Scaled to\nTrophic Interaction',
           'Nearby'=  'Nearby TIMs Only', 
           'Far' =  'Far TIMs Only',
           'Unif' ='Uniformally\nDistributed Strengths')

COLOURS <-   scale_colour_manual(values=ModelCols, labels=LABELS, name = 'TIM Model')

Interesting <-  c('Normal','Random',
                  'Positive', 'Negative',
                  'IncSkew' ,'DecSkew',
                  'Switching','BoundSw')

InterestingColours <-scale_colour_manual(values=ModelCols, 
                                         labels=LABELS[1:8],
                                         name = 'TIM Model',
                                         breaks= Interesting)

LEGEND <-theme(legend.text = element_text(size=10),
               legend.key = element_rect(size = 5),
               legend.key.size = unit(1.5, 'lines'))


```

## Figure 2: Demonstration of Interaction Matrices

```{r, message=FALSE, warning=FALSE}
set.seed(1)

J <- BuildWeb(mux = -1 , muy = 1,
              sigmax = 0.5, sigmay = 0.5, size=20,
              rhoxy = -0.8, connectance =0.2)
C <-  AddTIMsToMatrix(J,'Random',TIM_Dens = 5, TIMStrength = 0.5) 

ExampleB <- PlotMatrix(J, '')
ExampleA<-PlotMatrix(C, '')
ExampleC<-PlotMatrix(C-J, '')

Combined <- plot_grid(ExampleB, ExampleC, ExampleA,  ncol=3)

labels = c('A\nFull Interaction Matrix',
           'B\n Trophic Interactions',
           'C\nNon-Trophic Interactions')                     
Combined
#ggsave('Figures/ExampleMatrices.png', width = 10,height = 4, dpi =200 )
```

## Figure 3: Example TIM matrices by different distributions. 

`PlotTIMMatrices()` can access the different TIM models and return coloured matrix 

```{r, fig.height=12, fig.width=12}
ModelList <- c( 'Normal','Nearby', 'Far','EcoEng','TightRecip',
                'Positive', 'Negative','Unif','LaPlace', 'Scaled',
                'RanSkew', 'IncSkew','DecSkew',
                'Switching','BoundSw' )

matLABELS<- c('Baseline Model',
              'Near Modifications Only', 
              'Far Modifications Only',  
              'Ecological Engineer',
              'Reciprocal Modifications',
              'Facilitating Modifications',
              'Interfering Modifications',
              'Skewed Strength Distribution',
              'Uniform Strength Distribution',
              'Scaled to Direct Interaction',
              'Unbalanced Effects',
              'Larger Positive Effects',
              'Larger Negative Effects',
              'Mutual Interference',
              'Scaled Mutual Interference')

Lettered_Labels <- paste0(c('',  paste0(letters[1:14],') ') ),matLABELS)

plot_grid(plotlist = map2(ModelList,Lettered_Labels, PlotTIMMatrices, J, 8, 0.5 ), ncol = 4, label_size = 6 )

ggsave('Paper/Figures/SuppInfo/AllTIMMatrices.png', width = 12,height = 14 )
ggsave('Paper/Figures/SuppInfo/AllTIMMatrices.pdf', width = 12,height = 14 )

```

## Figure 4: Impact of TIMs on Stability in Artificial Webs

```{r}
dataB05-> data2
write.csv(data2, file = 'Generated Data/ArtificialWebData.csv')

data2 %>%
  mutate(Highlight = ifelse(TIM_Model %in% Interesting, 
                            'Yes',
                            'No'))->data2

glimpse(data2, width = 80)
```

```{r message=FALSE}
data2 %>%
  mutate(Instability = log(obs), 
         Reactivity=log(Reactivity)) %>%
  gather('Response', 'Value',
         Instability,
         Omega,
         Reactivity)%>%
  mutate(Response = factor(Response,
                           levels= c('Instability', 
                                     'Reactivity', 
                                     'Omega'),
                           labels = Labels <- c('a) Instability', 
                                                'b) Reactivity', 
                                                'c) Feasibility Domain')))-> df

ggplot(df, aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth(data= subset(df,Highlight=='No'), se = FALSE, alpha=0.5)+
  geom_smooth(data= subset(df,Highlight=='Yes'), se = FALSE, alpha=0.5)+
  geom_smooth(data= subset(df,TIM_Model=='Normal'), se = FALSE, alpha=0.5)+
  facet_wrap(~Response, scales = 'free' )+
  guides(col=FALSE)+
  theme(strip.background = element_blank(),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours -> TopRow


data2 %>%
  mutate(Stability = log(obs), 
         `Divergence from Tang Criterion` = log(Tang)-Stability,
         `Divergence from May Criterion` = log(May)-Stability) %>%
  gather('Response', 'Value',
         `Divergence from Tang Criterion`,
         `Divergence from May Criterion`)%>%
  mutate(Response = factor(Response,
                           levels= c('Divergence from May Criterion',
                                     'Divergence from Tang Criterion' ),
                           labels = c('d) Divergence from May Criterion',
                                      'e) Divergence from Tang et al. Criterion' )))-> df

ggplot(df, aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_hline(yintercept = 0, linetype=2, col= 'lightgrey') +
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth(data= subset(df,Highlight=='No'), se = FALSE, alpha=0.5)+
  geom_smooth(data= subset(df,Highlight=='Yes'), se = FALSE, alpha=0.5)+
  geom_smooth(data= subset(df,TIM_Model=='Normal'), se = FALSE, alpha=0.5)+
  facet_wrap(~Response, scales = 'free')+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours+
  LEGEND-> BottomRow

Both<-cowplot::plot_grid(TopRow, BottomRow, nrow = 2)

Both
ggsave('Paper/Figures/MainText/Figure4.pdf', width = 12, height = 9)
ggsave('Paper/Figures/MainText/Figure4.png', width = 12, height = 9, dpi=300)

```

## Sensitivity analysis with varying TIM strength and balance of trophic strengths

NB bound switching doesn't respond to changing TIM strength, so is removed

### Stability
```{r}

bind_rows(mutate(dataBal, CR_Balance = 'Balanced'),
          mutate(dataUn, CR_Balance = '5x'),
          mutate(dataVeUn, CR_Balance = '10x'))%>% 
  filter(TIM_Model != 'BoundSw')%>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Instability = log(obs))%>% 
  ggplot(aes(y = Instability, x = TIM_Dens, col= TIM_Model))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='Instability', 
       x='TIM Frequency')+
  facet_wrap(CR_Balance~TIMStrength,scales = 'free',
             labeller = label_both)+
  InterestingColours+LEGEND


ggsave('Paper/Figures/SuppInfo/Sens_Stability.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/Sens_Stability.png', width = 12, height = 9, dpi=300)


```

### Reactivity
```{r}

bind_rows(mutate(dataBal, CR_Balance = 'Balanced'),
          mutate(dataUn, CR_Balance = '5x'),
          mutate(dataVeUn, CR_Balance = '10x'))%>% 
  filter(TIM_Model != 'BoundSw')%>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Reactivity=log(Reactivity)) %>%
  ggplot(aes(y = Reactivity, x = TIM_Dens, col= TIM_Model))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='Reactivity', 
       x='TIM Frequency')+
  facet_wrap(CR_Balance~TIMStrength,scales = 'free',
             labeller = label_both)+
  InterestingColours+LEGEND


ggsave('Paper/Figures/SuppInfo/Sens_Reactivity.pdf', width = 12, height = 7)
ggsave('Paper/Figures/SuppInfo/Sens_Reactivity.png', width = 12, height = 7, dpi=300)


```

### Feasibility domain

```{r}

bind_rows(mutate(dataBal, CR_Balance = 'Balanced'),
          mutate(dataUn, CR_Balance = 'Unbalanced'),
          mutate(dataVeUn, CR_Balance = 'VeryUnBalanced'))%>%
  filter(TIM_Model != 'BoundSw')%>%
  filter(TIM_Model %in% Interesting) %>%
  ggplot(aes(y = Omega, x = TIM_Dens, col= TIM_Model))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='Size of Feasibility Domain', 
       x='TIM Frequency')+
  facet_wrap(CR_Balance~TIMStrength,scales = 'free',
             labeller = label_both)+
  InterestingColours+LEGEND

ggsave('Paper/Figures/SuppInfo/Sens_Feasibility.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/Sens_Feasibility.png', width = 12, height = 9, dpi=300)



dataBal %>%
  filter(TIM_Model != 'BoundSw')%>%
  filter(TIM_Model %in% Interesting) %>%
  rename(Zero =Omega, `Minus 2` = Omega_d2, `Minus 5`=Omega_d5,
         `TIM Strength` = TIMStrength)%>%
  gather('Diagonal', 'FeasibilityDomain',
         Zero, `Minus 2`, `Minus 5`)%>%
  ggplot(aes(y = FeasibilityDomain, x = TIM_Dens, col= TIM_Model))+
  geom_point()+
  geom_smooth(se=FALSE)+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  facet_wrap(Diagonal~`TIM Strength`,scales = 'free',
             labeller = label_both)+
  labs(title="",
       y='Size of Feasibility Domain', 
       x='TIM Frequency')+
  InterestingColours+LEGEND


ggsave('Paper/Figures/SuppInfo/Sens_Diagonal.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/Sens_Diagonal.png', width = 12, height = 9, dpi=300)

```

### Feasibility domain is strongly correlated between different diagonal choices. 

```{r}
dataBal%>%
  filter(TIM_Model == 'Switching' )%>%
  ggplot(aes(Omega, Omega_d5))+
  geom_point()+facet_wrap(TIMStrength  ~TIM_Dens, scales = 'free',
                          labeller = label_both)

ggsave('Paper/Figures/SuppInfo/Sens_DiagonalCorrelation.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/Sens_DiagonalCorrelation.png', width = 12, height = 9, dpi=300)
```

# Table detailing structural properties

Calculated with `PrintStructureTable()`. These ultimately output html code using the kable and kableextra packages. These functions are rather long winded and not very optimised, and spend most of there time rearranging data into the correct shape

```{r results='asis', message=FALSE, eval=FALSE}
sink<-PrintStructureTable(data2)
```

# Stability Of Non-highlighted Models

```{r}
data2 %>%
  mutate(Instability = log(obs), 
         Reactivity=log(Reactivity)) %>%
  gather('Response', 'Value',
         Instability,
         Omega,
         Reactivity)%>%
  mutate(Response = factor(Response,
                           levels= c('Instability', 
                                     'Reactivity', 
                                     'Omega'),
                           labels = Labels <- c('a) Instability', 
                                                'b) Reactivity', 
                                                'c) Feasibility Domain')))%>%
  filter(Highlight=='No') %>%
  ggplot(aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_point(size=0.5)+
  geom_smooth(se = FALSE)+
  facet_wrap(~Response, scales = 'free')+
  labs(title="",
       y='', 
       x='TIM Frequency per Species')+ 
  scale_color_brewer(palette = 'Dark2', labels=LABELS[9:16], name = 'TIM Model')+
  LEGEND-> NonHighlightedPlot

NonHighlightedPlot
ggsave('Paper/Figures/SuppInfo/NonHighlightedPlot.png',NonHighlightedPlot, width = 15, height = 6, dpi = 200)
ggsave('Paper/Figures/SuppInfo/NonHighlightedPlot.pdf',NonHighlightedPlot, width = 15, height = 6)
```

### Figures for Unbalanced Consumer-Resource Interactions

```{r}
dataU05%>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Instability = log(obs), 
         Reactivity=log(Reactivity)) %>%
  gather('Response', 'Value',
         Instability,
         Omega,
         Reactivity)%>%
  mutate(Response = factor(Response,
                           levels= c('Instability', 
                                     'Reactivity', 
                                     'Omega'),
                           labels = Labels <- c('a) Instability', 
                                                'b) Reactivity', 
                                                'c) Feasibility Domain')))%>%
  ggplot(aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth(se = FALSE)+
  facet_wrap(~Response, scales = 'free' )+
  guides(col=FALSE)+
  theme(strip.background = element_blank(),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours -> TopRow


dataU05 %>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Stability = log(obs), 
         `Divergence from Tang Criterion` = log(Tang)-Stability,
         `Divergence from May Criterion` = log(May)-Stability) %>%
  gather('Response', 'Value',
         `Divergence from Tang Criterion`,
         `Divergence from May Criterion`)%>%
  mutate(Response = factor(Response,
                           levels= c('Divergence from May Criterion',
                                     'Divergence from Tang Criterion' ),
                           labels = c('d) Divergence from May Criterion',
                                      'e) Divergence from Tang et al. Criterion' )))%>%
  ggplot(aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth( se = FALSE)+
  facet_wrap(~Response, scales = 'free')+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours+
  LEGEND-> BottomRow

BothdataUn<-cowplot::plot_grid(TopRow, BottomRow, nrow = 2)
BothdataUn
ggsave('Paper/Figures/SuppInfo/Unbalanced.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/Unbalanced.png', width = 12, height = 9, dpi=300)

```

```{r}
dataV05%>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Instability = log(obs), 
         Reactivity=log(Reactivity)) %>%
  gather('Response', 'Value',
         Instability,
         Omega,
         Reactivity)%>%
  mutate(Response = factor(Response,
                           levels= c('Instability', 
                                     'Reactivity', 
                                     'Omega'),
                           labels = Labels <- c('a) Instability', 
                                                'b) Reactivity', 
                                                'c) Feasibility Domain')))%>%
  ggplot(aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth(se = FALSE)+
  facet_wrap(~Response, scales = 'free' )+
  guides(col=FALSE)+
  theme(strip.background = element_blank(),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours -> TopRow

dataV05%>%
  filter(TIM_Model %in% Interesting) %>%
  mutate(Stability = log(obs), 
         `Divergence from Tang Criterion` = log(Tang)-Stability,
         `Divergence from May Criterion` = log(May)-Stability) %>%
  gather('Response', 'Value',
         `Divergence from Tang Criterion`,
         `Divergence from May Criterion`)%>%
  mutate(Response = factor(Response,
                           levels= c('Divergence from May Criterion',
                                     'Divergence from Tang Criterion' ),
                           labels = c('d) Divergence from May Criterion',
                                      'e) Divergence from Tang et al. Criterion' )))%>%
  ggplot(aes(y=Value, x=TIM_Dens, col=TIM_Model))+
  geom_jitter(size=0.5 , width = 0.2, height = 0, alpha = 0.5 )+
  geom_smooth(se = FALSE)+
  facet_wrap(~Response, scales = 'free')+
  theme(strip.background = element_rect(fill = 'white'),
        strip.text = element_text(hjust = 0.1, margin = margin(1,1,1,1)))+
  labs(title="",
       y='', 
       x='TIM Frequency')+InterestingColours+
  LEGEND-> BottomRow

BothdataVeryUn<-cowplot::plot_grid(TopRow, BottomRow, nrow = 2)
BothdataVeryUn
ggsave('Paper/Figures/SuppInfo/VeryUnbalanced.pdf', width = 12, height = 9)
ggsave('Paper/Figures/SuppInfo/VeryUnbalanced.png', width = 12, height = 9, dpi=300)
```


# Correlation of Feasibility With Network Features

```{r}
data2 %>%
  filter(TIM_Model %in% c("Normal","Random","Positive",
                          "Negative","IncSkew","DecSkew", "Switching")) %>% 
mutate(TIM_Model = ifelse(TIM_Model=="Normal" ,  "Baseline\nTIM Model"  ,TIM_Model),
       TIM_Model = ifelse(TIM_Model=="Random" , "Random NTEs" ,TIM_Model),
       TIM_Model = ifelse(TIM_Model== "Positive",  "Facilitating\nModifications" ,TIM_Model),
       TIM_Model = ifelse( TIM_Model=="Negative", "Interfering\nModifications",TIM_Model),
       TIM_Model = ifelse(TIM_Model=="IncSkew", "Larger\nPositive Effects" ,TIM_Model),
       TIM_Model = ifelse(TIM_Model=="DecSkew" , "Larger\nNegative Effects",TIM_Model),
       TIM_Model = ifelse(TIM_Model== "Switching",  "Mutual\nInterference",TIM_Model))%>%
    select(Omega,TIM_Model,
         V, C_VAR, cov, rho,mu, MeanMagNT)%>%
  rename(`Total Variance`=V,
         `Non-Trophic\nVariance`= C_VAR,
         `Covariance between\nTrophic and Non-Trophic`=cov,
         `Total Pairwise\nCorrelation`=rho,
         `Total Mean\nInteraction Strength`=mu,
         `Mean Non-Trophic\nEffect Magnitude`=MeanMagNT)%>%
  gather( 'Metric', 'Value', `Total Variance`:`Mean Non-Trophic\nEffect Magnitude`)%>%
  ggplot(aes(Value, Omega))+
  geom_point(size =0.5)+
    facet_grid(TIM_Model~Metric, scales = 'free')+
  ylab('Size of Feasibility Domain')+
  xlab('Value of Structural Metric')+
  guides(col=FALSE)+
  theme(strip.text = element_text(size = 10))


  
ggsave('Paper/Figures/SuppInfo/EffectOfStructureOnFeasib.pdf', width=11, height = 11)
ggsave('Paper/Figures/SuppInfo/EffectOfStructureOnFeasib.png', width=11, height = 11, dpi=300)

```



# Supplementary Rho Figures
```{r}
data2 %>%
  filter(TIM_Model %in% Interesting) %>%
  ggplot(aes(y=obs, x=rho))+
  scale_y_log10()+
  geom_point(size=0.5, alpha=0.5, aes(col=TIM_Model))+
  geom_smooth(se = FALSE, method = lm , col='black')+
  labs(title="",
       y='Self-regulation required for stability',
       x='Pairwise Correlation')+ InterestingColours+LEGEND -> RhoStab

data2 %>%
  filter(TIM_Model %in% Interesting) %>%
  ggplot(aes(y=rho, x=TIM_Dens, col=TIM_Model))+
  geom_point(size=0.5, alpha=0.5)+
  geom_smooth(se = FALSE)+
  labs(title="",
       y='Pairwise Correlation',
       x='TIM Density per Species')+ InterestingColours+LEGEND -> TIMRho

BothRhoPlots<-plot_grid(RhoStab+guides(col=FALSE), TIMRho, rel_widths = c(2,3), labels = c('(a)', '(b)'))
BothRhoPlots
ggsave('Paper/Figures/SuppInfo/SIBothRhoPlots.png', BothRhoPlots, width = 12, height = 6, dpi = 300)
ggsave('Paper/Figures/SuppInfo/SIBothRhoPlots.pdf', BothRhoPlots, width = 12, height = 6)

```

# Other Small analyses

### Figure Explaining row structure paterning

The trophic interaction matrices do not have the characteristic banding pattern than is commonly observed in empirical networks. 

Here we multiply each trophic interaction matrix and each non-trophic interaction matrix by a vector of positive numbers that represent the biomass terms of each of the species.

These vectors are drawn from a log-normal distribution ( so the values are always positive, and therefore has a distribution appropriate), to give a distribution of mean 1 and SD of approximately 2.5

```{r message=FALSE, warning=FALSE}
set.seed(1)

B <- BuildWeb(mux = -1 , muy = 1,
              sigmax = 0.5, sigmay = 0.5, size=20,
              rhoxy = -0.8, connectance =0.3)
A <-  AddTIMsToMatrix(B,'Random',TIM_Dens = 5, TIMStrength = 0.5) 

C <- A-B
V <- rlnorm(dim(B)[1], -1, sqrt(2))
B_row = B*V 
C_row = C*V

OrigB <- PlotMatrix(B, '')
OrigC <- PlotMatrix(C, '')
RowSB <- PlotMatrix(B_row, '')
RowSC <- PlotMatrix(C_row, '')

Combined <- plot_grid(OrigB,RowSB, OrigC,RowSC,  ncol=2, labels = c('B:Trophic Interactions',
                                                                    'B:Trophic Interactions with Row Structure',
                                                                    'C:Non-Trophic Interactions',
                                                                    'C:Non-Trophic Interactions with Row Structure'), label_x = 0, label_size = 8  )
Combined

```

## Balance of positive element

The main results include which term the stability criteria used. With increasing skew, the 'dot' element of the stability criterion dominates in almost all Tang criteria and nearly as many May criteria for Larger positive effects. Where the 'dot' estimator dominated, both criteria gave estimates as being more unstable than observed.

```{r}
data2 %>%
  filter(DotToRightOfDiskMay == TRUE) %>%
  group_by(TIM_Dens)%>%
  summarise(n())

data2 %>%
  filter(DotToRightOfDiskTang == TRUE) %>%
  group_by(TIM_Model)%>%
  summarise(n())

```

## Hermetian Matrices from communities with NTEs
What is driving the reactivity patterns?

```{r}
# adding random NTEs back in for competeness
ModelList <- c('Random', ModelList)
```

```{r, message=FALSE, warning=FALSE}

B <- BuildWeb(mux = -1 , muy = 1,
              sigmax = 0.5, sigmay = 0.5, size=30,
              rhoxy = -0.8, connectance =0.2)
```

```{r, fig.height=12, fig.width=8}

H_Matrices<- map(ModelList, PlotH, B, 20, 0.5 )

plot_grid(plotlist = c(H_Matrices ), ncol = 4 )+
  draw_plot_label(label=c('Random Interactions',matLABELS),
                  x=rep((0.5+(0:3))/4, 4),
                  y=1-(1-0.9+rep(0:3, each=4))/4,
                  hjust=.5, vjust=.5, size=6)


ggsave('Paper/Figures/SuppInfo/HermitianMatrices.pdf', width = 6, height =8)
```

# Session Info

```{r}
sessionInfo()
```

